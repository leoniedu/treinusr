---
title: "Getting Started with treinusr"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with treinusr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

## Installation

```{r}
# Install from GitHub
pak::pak("edColumn/treinusr")
```

## Authentication Setup

### Secure Credential Storage

Store your Treinus credentials using environment variables:

```{r}
library(treinusr)

# Interactive setup - will prompt for password securely
treinus_set_credentials()
```

This saves your credentials to `~/.Renviron`. After running this, restart R or run:

```{r}
readRenviron("~/.Renviron")
```

### Verify Configuration

```{r}
treinus_config()
treinus_has_credentials()
```

## Basic Usage

### Create a Session

```{r}
session <- treinus_auth()
```

If you belong to multiple teams, you'll be prompted to select one.

### Check Session Status

```{r}
treinus_session_valid(session)
```

## Retrieving Data

### Get Exercises

```{r}
# Get exercises for a single athlete
exercises <- treinus_get_exercises(session, athlete_id = 50)

# Get exercises for multiple athletes
exercises <- treinus_get_exercises_batch(
  session,
  athlete_ids = c(50, 51, 52),
  .progress = TRUE
)
```

### Get Exercise Analysis

Retrieve detailed GPS and sensor data for a specific exercise:
```{r}
analysis <- treinus_get_exercise_analysis(
  session,
  exercise_id = 57,
  athlete_id = 50,
  team_id = 2994
)
```

### Extract Records

Extract time-series records from the analysis:

```{r}
# Raw records with unit metadata as attributes
records <- treinus_extract_records(analysis)

# Check units
attr(records, "DistanceUnit")
attr(records, "SpeedUnit")
attr(records, "CadenceUnit")
```

For standardized units (coordinates in degrees, distance in km, speed in km/h):

```{r}
records <- treinus_extract_records(analysis, standardize = TRUE)

# Now includes:
# - timestamp: POSIXct
# - lat, lon: degrees
# - distance_km: kilometers
# - speed_kmh: km/h
```

### Custom API Requests

For endpoints not yet wrapped:

```{r}
resp <- treinus_request(
  session,
  endpoint = "/Athlete/Performance/Index",
  method = "GET"
)

# Parse HTML response
page <- httr2::resp_body_html(resp)
data <- treinus_parse_table(page)
```

## Workflow Example

```{r}
library(treinusr)
library(dplyr)

# Authenticate
session <- treinus_auth()

# Get exercises
exercises <- treinus_get_exercises(session, athlete_id = 50)

# Get analysis for most recent exercise
latest <- exercises |> slice(1)

analysis <- treinus_get_exercise_analysis(
  session,
  exercise_id = latest$id_exercise_done,
  athlete_id = 50,
  team_id = latest$id_team
)

# Extract standardized records
records <- treinus_extract_records(analysis, standardize = TRUE)

# Analyze
records |>
  summarise(
    duration_min = as.numeric(difftime(max(timestamp), min(timestamp), units = "mins")),
    distance_km = max(distance_km),
    avg_speed_kmh = mean(speed_kmh, na.rm = TRUE),
    avg_hr = mean(heart_rate, na.rm = TRUE)
  )
```

## Best Practices

1. **Never commit credentials** - Use environment variables via `.Renviron`

2. **Reuse sessions** - Create one session and reuse it for multiple requests

3. **Error handling** - Wrap API calls in `tryCatch()` for production code

```{r}
result <- tryCatch(
  {
    session <- treinus_auth()
    treinus_get_exercises(session, athlete_id = 50)
  },
  error = function(e) {
    message("Failed: ", e$message)
    NULL
  }
)
```

## Troubleshooting

### Authentication Fails

1. Verify credentials: `treinus_config()`
2. Check you can log in via the web interface
3. Restart R after setting environment variables

### Session Expired

```{r}
if (!treinus_session_valid(session)) {
  session <- treinus_auth()
}
```
